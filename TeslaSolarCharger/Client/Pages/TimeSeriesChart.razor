@page "/TimeSeries/{carId:int}/{startEpoch:long}/{endEpoch:long}"

@using TeslaSolarCharger.Shared.Dtos.TimeSeries
@using TeslaSolarCharger.Shared.Enums
@using TeslaSolarCharger.Shared.Helper.Contracts
@using TeslaSolarCharger.Shared.Localization
@using TeslaSolarCharger.Shared.Localization.Contracts
@using TeslaSolarCharger.Shared.Localization.Registries
@using TeslaSolarCharger.Shared.Localization.Registries.Pages

@inject HttpClient Http
@inject IStringHelper StringHelper
@inject ITextLocalizationService TextLocalizer

<div>
    <MudTimeSeriesChart ChartSeries="@_series"
                        Width="100%" Height="350px"
                        ChartOptions="@_options"
                        CanHideSeries
                        TimeLabelSpacing="TimeSpan.FromSeconds((EndEpoch - StartEpoch) / 10)" />
</div>

@code
{
    [Parameter]
    public int CarId { get; set; }
    [Parameter]
    public long StartEpoch { get; set; }
    [Parameter]
    public long EndEpoch { get; set; }


    private readonly ChartOptions _options = new ChartOptions
        {
            YAxisLines = false,
            YAxisRequireZeroPoint = true,
            XAxisLines = false,
            LineStrokeWidth = 1,
        };

    private readonly List<TimeSeriesChartSeries> _series = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadTimeSeriesData();
    }

    private async Task LoadTimeSeriesData()
    {
        await AddChartSeries(CarValueType.ModuleTempMin).ConfigureAwait(false);
        await AddChartSeries(CarValueType.ModuleTempMax).ConfigureAwait(false);
        await AddChartSeries(CarValueType.StateOfCharge).ConfigureAwait(false);
        await AddChartSeries(CarValueType.StateOfChargeLimit).ConfigureAwait(false);

        StateHasChanged();
    }

    private async Task AddChartSeries(CarValueType carValueType)
    {
        var response = await Http.GetFromJsonAsync<List<DtoTimeSeriesDatum>>($"api/TimeSeriesData/GetTimeSeriesData?carId={CarId}&startEpoch={StartEpoch}&endEpoch={EndEpoch}&carValueType={carValueType}");
        if (response != null && response.Count > 0)
        {
            var chartSeries = new TimeSeriesChartSeries
            {
                Index = 0,
                    Name = GetSeriesName(carValueType),
                Data = response.Select(d => new TimeSeriesChartSeries.TimeValue(d.Timestamp, d.Value ?? 0)).ToList(),
                IsVisible = true,
                LineDisplayType = LineDisplayType.Line,
            };
            _series.Add(chartSeries);
        }
    }

    private string GetSeriesName(CarValueType carValueType)
    {
        return carValueType switch
        {
            CarValueType.ModuleTempMin => T(TranslationKeys.TimeSeriesChartModuleTempMin),
            CarValueType.ModuleTempMax => T(TranslationKeys.TimeSeriesChartModuleTempMax),
            CarValueType.StateOfCharge => T(TranslationKeys.TimeSeriesChartStateOfCharge),
            CarValueType.StateOfChargeLimit => T(TranslationKeys.TimeSeriesChartStateOfChargeLimit),
            _ => StringHelper.GenerateFriendlyStringFromPascalString(carValueType.ToString())
        };
    }

    private string T(string key) =>
        TextLocalizer.Get<TimeSeriesChartPageLocalizationRegistry>(key, typeof(SharedComponentLocalizationRegistry))
        ?? key;
}