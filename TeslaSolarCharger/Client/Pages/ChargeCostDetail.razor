@page "/ChargePrice/detail/{chargeCostId:int}"
@page "/ChargePrice/new"
@using TeslaSolarCharger.Shared.Dtos.ChargingCost
@using TeslaSolarCharger.Shared.Contracts
@using TeslaSolarCharger.Shared.Dtos.ChargingCost.CostConfigurations
@using TeslaSolarCharger.Shared.Enums
@using Newtonsoft.Json
@using TeslaSolarCharger.Shared.Dtos
@using System.ComponentModel
@using System.Linq
@using TeslaSolarCharger.Shared.Attributes
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject IDateTimeProvider DateTimeProvider
@inject ISnackbar Snackbar

<button class="btn btn-primary" @onclick="NavigateToList">All Charge costs</button>
<h1>ChargePriceDetail</h1>

@if (ChargePrice == null)
{
    <div class="spinner"></div>
}
else
{
    <EditForm Model="ChargePrice" OnValidSubmit="@SaveChargePrice">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <GenericInput For="() => ChargePrice.Id" IsReadOnlyParameter="true" />

        <GenericInput For="() => ChargePrice.ValidSince" />

        <GenericInput For="() => ChargePrice.SolarPrice" />
        
        <GenericInput For="() => ChargePrice.EnergyProvider" DropDownOptions="EnergyProviderOptions" OnValueChanged="EnergyProviderChanged" />

        <GenericInput For="() => ChargePrice.GridPrice" LabelName="@(ChargePrice.AddSpotPriceToGridPrice ? "Base Price (Spot price will be added to this price)" : "Grid Price")" />

        @if (ChargePrice.EnergyProvider == EnergyProvider.FixedPrice && FixedPrices != null)
        {
            <div>You can specify times with special prices here. If there are times left, you didn't specify a price for, the default grid price, specified above, is used.</div>
            @foreach (var fixedPrice in FixedPrices)
            {
                <div class="row mt-3">
                    <div class="col-auto">
                        <FixedPriceComponent FixedPrice="fixedPrice"></FixedPriceComponent>
                    </div>
                    
                </div>
                <div class="row mt-3">
                    <div class="col-auto">
                        <GenericInput For="() => fixedPrice.Value" />
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-danger m-2" @onclick="_ => DeleteFixedPrice(fixedPrice)"><span class="oi oi-trash" aria-hidden="true"></span></button>
                    </div>
                </div>
                
                <hr/>
            }
            <button type="button" class="btn btn-primary m-2" @onclick="AddFixedPrice">Add time based price</button>
        }
        
        @if (ChargePrice.EnergyProvider == EnergyProvider.OldTeslaSolarChargerConfig)
        {
            <div class="mb-3">
                <InputCheckbox class="form-check-input" id="useSpotPrice1" @bind-Value="ChargePrice.AddSpotPriceToGridPrice" />
                <label class="form-check-label" for="useSpotPrice1">
                    Use Spot Prices
                </label>
                <div>
                    <small id="UseSpotPriceHelp" class="form-text text-muted">Enable this if you are using dynamic prices based on EPEX Spot DE (e.g. Tibber or aWATTar)</small>
                </div>
            </div>
            @if (ChargePrice.AddSpotPriceToGridPrice)
            {
                <GenericInput For="() => ChargePrice.SpotPriceSurcharge" />
            }
        }
        
        <br/>
        @if(ChargePricesUpdateText != null)
        {
            <div class="alert alert-warning" role="alert">
                @ChargePricesUpdateText
            </div>
        }
        <button type="submit" class="btn btn-primary" disabled="@(ChargePricesUpdateText != null)">
            @if (SubmitIsLoading)
            {
                <span>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                </span>
            }
            else
            {
                <span>Save</span>
            }
        </button>
        <div>
            <small class="form-text text-muted">Note: updating charge prices can take a significant ammount of time as the price of all previous charges is updated</small>
        </div>
    </EditForm>
}


@code {
    [Parameter]
    public int? ChargeCostId { get; set; }

    private DtoChargePrice? ChargePrice { get; set; }

    private bool SubmitIsLoading { get; set; }

    private List<FixedPrice>? FixedPrices { get; set; }

    private readonly Dictionary<int, string> EnergyProviderOptions = Enum.GetValues<EnergyProvider>()
        .ToDictionary(e => (int)e, e => e.ToString().Replace("OldTeslaSolarChargerConfig", "Fixed Price or Spot price").Replace("FixedPrice", "Time based prices"));

    public string? ChargePricesUpdateText { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ChargePricesUpdateText = (await HttpClient.GetFromJsonAsync<DtoValue<string?>>($"api/ChargingCost/GetChargePricesUpdateText").ConfigureAwait(false))?.Value;
        if (ChargeCostId != null)
        {
            ChargePrice = await HttpClient.GetFromJsonAsync<DtoChargePrice>($"api/ChargingCost/GetChargePriceById?id={ChargeCostId}").ConfigureAwait(false);
            if(ChargePrice is { EnergyProviderConfiguration: not null, EnergyProvider: EnergyProvider.FixedPrice })
            {
                FixedPrices = JsonConvert.DeserializeObject<List<FixedPrice>>(ChargePrice.EnergyProviderConfiguration);
            }
        }
        else
        {
            ChargePrice = new DtoChargePrice()
            {
                ValidSince = DateTimeProvider.Now(),
                GridPrice = new decimal(0.285),
                SolarPrice = new decimal(0.12),
                EnergyProvider = EnergyProvider.OldTeslaSolarChargerConfig,
            };
        }
    }

    void NavigateToList()
    {
        NavigationManager.NavigateTo("/ChargePrices");
    }

    private async Task SaveChargePrice()
    {
        SubmitIsLoading = true;
        if(ChargePrice == null)
        {
            Snackbar.Add("Charge price is null and can not be saved. Try reloading the page.", Severity.Error);
            return;
        }
        if(ChargePrice.EnergyProvider == EnergyProvider.FixedPrice)
        {
            ChargePrice.EnergyProviderConfiguration = JsonConvert.SerializeObject(FixedPrices);
        }
        else
        {
            ChargePrice.EnergyProviderConfiguration = null;
        }
        HttpClient.PostAsJsonAsync("api/ChargingCost/UpdateChargePrice", ChargePrice).ConfigureAwait(false);
        NavigateToList();
    }

    private void EnergyProviderChanged(EnergyProvider energyProvider)
    {
        if(ChargePrice == null)
        {
            return;
        }
        ChargePrice.EnergyProvider = energyProvider;
        FixedPrices = energyProvider == EnergyProvider.FixedPrice ? new List<FixedPrice>() : null;
    }

    private void AddFixedPrice()
    {
        FixedPrices?.Add(new FixedPrice()
        {
            ValidOnDays = new List<DayOfWeek>(),
        });
    }

    private void DeleteFixedPrice(FixedPrice fixedPrice)
    {
        FixedPrices?.Remove(fixedPrice);
    }

}
