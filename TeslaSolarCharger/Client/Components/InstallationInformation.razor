@using System.Globalization
@using TeslaSolarCharger.Client.Helper.Contracts
@using TeslaSolarCharger.Shared.Dtos
@using TeslaSolarCharger.Shared.Localization
@using TeslaSolarCharger.Shared.Localization.Contracts
@using TeslaSolarCharger.Shared.Localization.Registries
@using TeslaSolarCharger.Shared.Localization.Registries.Components

@inject IHttpClientHelper HttpClientHelper
@inject ISnackbar Snackbar
@inject ITextLocalizationService TextLocalizer

<div class="shadow p-3 mb-5 bg-white rounded auto-scroll">
    @if (_serverTimeZoneDisplayName != default)
    {
        <div>
            <TooltipComponent Text='@T(TranslationKeys.InstallationInfoServerTimezone)'>
                <span>@T(TranslationKeys.InstallationInfoServerTimezone)</span>: @_serverTimeZoneDisplayName
            </TooltipComponent>
        </div>
    }
    @if (_serverTime != default)
    {
        <div>
            <TooltipComponent Text='@T(TranslationKeys.InstallationInfoServerTime)'>
                <span>@T(TranslationKeys.InstallationInfoServerTime)</span>: @_serverTime?.ToString(CultureInfo.CurrentCulture)
            </TooltipComponent>
        </div>
    }
    @if (string.IsNullOrWhiteSpace(_version))
    {
        <p>
            <em>@T(TranslationKeys.BaseConfigurationCouldNotGetResult)</em>
        </p>
    }
    else
    {
        <p>
            <em>@T(TranslationKeys.InstallationInfoVersion): <a href="https://github.com/pkuehnel/TeslaSolarCharger/releases/tag/v@_version" target="_blank">@_version</a></em>
        </p>
    }
    <div>
        <b>@T(TranslationKeys.InstallationInfoInstallationId)</b>:
        <TextShortenComponent InputString="@_installationId"
                              MaxLength="18"
                              ShouldDisplayTruncatedCharCount="true"
                              TooltipText='@T(TranslationKeys.InstallationInfoDoNotShareId)'
                              OnCopyClicked="ShowInstallationIdWarning"></TextShortenComponent>
    </div>
    <div>
        <b>@T(TranslationKeys.InstallationInfoLanguageSettings)</b>: @CultureInfo.CurrentCulture
    </div>
</div>

@code {
    private DateTime? _serverTime;
    private string? _serverTimeZoneDisplayName;
    private string _installationId = "";
    private string _version = "";


    protected override async Task OnInitializedAsync()
    {
        await RefreshServerTime();
        await RefreshServerTimeZone();
        await RefreshVersion();
        await RefreshInstallationId();
    }

    private async Task RefreshServerTime()
    {
        var result = await HttpClientHelper.SendGetRequestAsync<DtoValue<DateTime>>("api/Hello/GetServerLocalTime");
        _serverTime = result.Data?.Value;
    }

    private async Task RefreshServerTimeZone()
    {
        var result = await HttpClientHelper.SendGetRequestAsync<DtoValue<string>?>("api/Hello/GetServerTimeZoneDisplayName");
        _serverTimeZoneDisplayName = result.Data?.Value;
    }

    private async Task RefreshVersion()
    {
        var result = await HttpClientHelper.SendGetRequestAsync<DtoValue<string?>?>("api/Hello/ProductVersion");
        if (result.HasError)
        {
            _version = string.Empty;
            return;
        }
        _version = result.Data?.Value ?? string.Empty;
    }

    private async Task RefreshInstallationId()
    {
        var result = await HttpClientHelper.SendGetRequestAsync<DtoValue<string>?>("api/Hello/GetInstallationId");
        if (result.HasError)
        {
            _installationId = string.Empty;
            return;
        }
        _installationId = result.Data?.Value ?? string.Empty;
    }

    private string T(string key) =>
        TextLocalizer.Get<InstallationInformationLocalizationRegistry>(key, typeof(SharedComponentLocalizationRegistry))
        ?? key;

    private void ShowInstallationIdWarning()
    {
        Snackbar.Add(T(TranslationKeys.InstallationInfoDoNotShareId), Severity.Warning);
    }
}
