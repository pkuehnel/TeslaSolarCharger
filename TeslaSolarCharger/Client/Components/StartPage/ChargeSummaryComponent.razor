@using TeslaSolarCharger.Client.Services.Contracts
@using TeslaSolarCharger.Shared.Dtos.ChargingCost
@using TeslaSolarCharger.Shared.Localization
@using TeslaSolarCharger.Shared.Localization.Contracts
@using TeslaSolarCharger.Shared.Localization.Registries
@using TeslaSolarCharger.Shared.Localization.Registries.Components.StartPage
@using TeslaSolarCharger.Shared.Resources.Contracts

@inject IConstants Constants
@inject IHomeService HomeService
@inject ITextLocalizationService TextLocalizer


@if (_chargeSummary == default)
{
    <PlaceholderComponent Count="5"></PlaceholderComponent>
}
else
{
    <div class="d-flex align-items-center mb-1">
        <MudIcon Class="mr-1" Icon="@Icons.Material.Filled.SolarPower"></MudIcon>
        <TooltipComponent Text="@T(TranslationKeys.ChargeSummarySolarEnergy)">
            @_chargeSummary.ChargedSolarEnergy.ToString("0.00") kWh (@_chargeSummary.SolarPortionPercent.ToString("0.0") %)
        </TooltipComponent>
    </div>
    @if (_chargeSummary.ChargedHomeBatteryEnergy > 0)
    {
        <div class="d-flex align-items-center mb-1">
            <MudIcon Class="mr-1" Icon="@Icons.Material.Filled.BatteryFull"></MudIcon>
            <TooltipComponent Text="@T(TranslationKeys.ChargeSummaryHomeBatteryEnergy)">
                @_chargeSummary.ChargedHomeBatteryEnergy.ToString("0.00") kWh (@_chargeSummary.HomeBatteryPortionPercent.ToString("0.0") %)
            </TooltipComponent>
        </div>
    }

    <div class="d-flex align-items-center mb-1">
        <MudIcon Class="mr-1" Icon="@Constants.GridPoleIcon"></MudIcon>
        <TooltipComponent Text="@T(TranslationKeys.ChargeSummaryGridEnergy)">
            @_chargeSummary.ChargedGridEnergy.ToString("0.00") kWh (@((100 - _chargeSummary.SolarPortionPercent - _chargeSummary.HomeBatteryPortionPercent).ToString("0.0")) %)
        </TooltipComponent>
    </div>
    <div class="d-flex align-items-center mb-1">
        <MudIcon Class="mr-1" Icon="@Icons.Material.Filled.AttachMoney"></MudIcon>
        <TooltipComponent Text="@T(TranslationKeys.ChargeSummaryCost)">
            <a href="@($"HandledCharges?carId={CarId}&chargingConnectorId={ChargingConnectorId}")">@_chargeSummary.ChargeCost.ToString("0.00") (@string.Format(T(TranslationKeys.ChargeSummaryPricePerKwh), _chargeSummary.AverageEnergyPrice.ToString("0.000")))</a>
        </TooltipComponent>
    </div>
}


@code {
    [Parameter]
    public int? CarId { get; set; }

    [Parameter]
    public int? ChargingConnectorId { get; set; }

    private DtoChargeSummary? _chargeSummary;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        await RefreshChargeSummary();
    }

    private async Task RefreshChargeSummary()
    {
        _chargeSummary = default;
        _chargeSummary = await HomeService.GetChargeSummary(CarId, ChargingConnectorId);
    }

    private string T(string key)
    {
        return TextLocalizer.Get<ChargeSummaryComponentLocalizationRegistry>(key, typeof(SharedComponentLocalizationRegistry))
               ?? key;
    }

}
