@page "/Prediction"
@using TeslaSolarCharger.Shared.Localization

@using TeslaSolarCharger.Client.Services.Contracts
@using ApexCharts
@using TeslaSolarCharger.Client.Dtos
@using TeslaSolarCharger.Client.Helper.Contracts
@using TeslaSolarCharger.Shared.Contracts
@using TeslaSolarCharger.Shared.Resources.Contracts
@using System.Globalization
@using TeslaSolarCharger.Shared.Localization.Contracts
@using TeslaSolarCharger.Shared.Localization.Registries
@using TeslaSolarCharger.Shared.Localization.Registries.Components.StartPage
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size

@inject IEnergyDataService EnergyDataService
@inject TimeProvider TimeProvider
@inject ISnackbar Snackbar
@inject IChartWidthCalculator ChartWidthCalculator
@inject IApexChartHelper ApexChartHelper
@inject IConstants Constants
@inject IDateTimeProvider DateTimeProvider
@inject ITextLocalizationService TextLocalizer

@implements IDisposable

<MudExpansionPanels>
    <MudExpansionPanel ExpandedChanged="isExpanded => ExpandedChanged(isExpanded)">
        <TitleContent>
            @if (_isExpanded)
            {
                <!-- Date Selection (only visible when expanded) -->
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <MudFab StartIcon="@Icons.Material.Filled.ArrowLeft"
                            Color="Color.Primary"
                            Size="Size.Small"
                            OnClick="PreviousDay"
                            Disabled="IsPreviousDisabled" />
                    <GenericInput T="DateTime?"
                                  For="() => SelectedDate"
                                  LabelName='@T(TranslationKeys.Date)'
                                  OnValueChanged="newDate => SelectedDateChanged(newDate)" />
                    <MudFab StartIcon="@Icons.Material.Filled.ArrowRight"
                            Color="Color.Primary"
                            Size="Size.Small"
                            OnClick="NextDay"
                            Disabled="IsNextDisabled" />
                </div>                
            }
            else
            {
                <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
                    @if (_dataLoaded)
                    {
                        @foreach (var item in GetLegendItems())
                        {
                            <LegendItemComponent TooltipText="@item.TooltipText"
                                                 Color="@item.Color"
                                                 Icon="@item.Icon"
                                                 Value="@item.Value" />
                        }
                    }
                    else
                    {
                        <MudSkeleton Width="100%" Height="24px" />
                    }
                </div>

            }
            
        </TitleContent>
        <ChildContent>
            @if (HousePredictionData == default
                        || SolarActualData == default
                        || HouseActualData == default
                        || BatteryDischargingData == default
                        || PowerFromGridData == default
                        || BatteryChargingData == default
                        || PowerToGridData == default
                        || BatterySoc == default
                        || (SolarPredictionData == default && _isSolarPredictionEnabled)
                        || (!_dataLoaded))
            {
                <div class="align-items-center justify-content-center mb-3">
                    <PlaceholderComponent Height="@($"{ChartHeightValue + 20}px")"></PlaceholderComponent>
                </div>
            }
            else
            {
                <!-- Consumption Chart -->
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <ApexChart TItem="DtoChartValue<int, decimal?>"
                               Options="_chartOptions"
                               Width="@ChartWidthCalculator.ChartWidth"
                               Height="@ChartHeight"
                               XAxisType="XAxisType.Numeric"
                               FormatXAxisLabel="@(arg => arg.ToString("N0"))"
                               FormatYAxisLabel="@(arg => arg.ToString("F1"))"
                               @ref="_consumptionChart">

                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="BatteryChargingData"
                                         Name='@Format("Battery Charging ({0} kWh)", BatteryChargingData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.BatteryChargingColor"
                                         Group="production-stack" />
                        
                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="BatterySoc"
                                         Name='@T(TranslationKeys.HomeBatterySoc)'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.BatterySocColor"/>
                        
                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="BatteryDischargingData"
                                         Name='@Format("Battery Discharge ({0} kWh)", BatteryDischargingData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.BatteryDischargingColor"
                                         Group="consumption-stack"/>

                        <!-- House Prediction Line -->
                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="HousePredictionData"
                                         Name='@Format("House Prediction ({0} kWh)", HousePredictionData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.HomeConsumptionPredictionColor"/>


                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="HouseActualData"
                                         Name='@Format("House Actual ({0} kWh)", HouseActualData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.HomeConsumptionChartColor"
                                         Group="consumption-stack"/>


                        @if (SolarPredictionData != default)
                        {
                            <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                             Items="SolarPredictionData"
                                             Name='@Format("Solar Prediction ({0} kWh)", SolarPredictionData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                             SeriesType="SeriesType.Line"
                                             XValue="@(e => e.Key)"
                                             YValue="@(e => e.Value)"
                                             Color="@Constants.SolarPowerPredictionColor"/>
                        }

                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="SolarActualData"
                                         Name='@Format("Solar Actual ({0} kWh)", SolarActualData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.SolarPowerColor"
                                         Group="production-stack"/>

                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="PowerToGridData"
                                         Name='@Format("Grid Export ({0} kWh)", PowerToGridData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.GridExportColor"
                                         Group="production-stack"/>
                        
                        <ApexPointSeries TItem="DtoChartValue<int, decimal?>"
                                         Items="PowerFromGridData"
                                         Name='@Format("Grid Import ({0} kWh)", PowerFromGridData.Sum(v => v.Value ?? 0).ToString("F1", CultureInfo.CurrentCulture))'
                                         SeriesType="SeriesType.Line"
                                         XValue="@(e => e.Key)"
                                         YValue="@(e => e.Value)"
                                         Color="@Constants.GridImportColor"
                                         Group="consumption-stack"/>


                    </ApexChart>
                </div>
            }
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>

@code {
    private List<DtoChartValue<int, decimal?>>? SolarPredictionData { get; set; }
    private List<DtoChartValue<int, decimal?>>? HousePredictionData { get; set; }
    private List<DtoChartValue<int, decimal?>>? SolarActualData { get; set; }
    private List<DtoChartValue<int, decimal?>>? HouseActualData { get; set; }

    private List<DtoChartValue<int, decimal?>>? BatteryDischargingData { get; set; }
    private List<DtoChartValue<int, decimal?>>? PowerFromGridData { get; set; }
    private List<DtoChartValue<int, decimal?>>? PowerToGridData { get; set; }
    private List<DtoChartValue<int, decimal?>>? BatteryChargingData { get; set; }
    private List<DtoChartValue<int, decimal?>>? BatterySoc { get; set; }

    private DateTime? SelectedDate { get; set; }
    private DateTime MaxAllowedDate => TimeProvider.GetLocalNow().Date.AddDays(7);
    private ApexChartOptions<DtoChartValue<int, decimal?>>? _chartOptions;
    private bool _isSolarPredictionEnabled;
    private bool _dataLoaded;
    private bool _isExpanded;
    private ApexChart<DtoChartValue<int, decimal?>>? _consumptionChart;

    private int ChartHeightValue { get; set; } = 470;
    private string ChartHeight => $"{ChartHeightValue}px";
    private CancellationTokenSource _refreshCancellationTokenSource = new CancellationTokenSource();

    //This values was determined by testing. Is used to not get an error when setting series values to null and to redraw the chart after a browser width change.
    private const int RedrawDelayMilliseconds = 50;

    protected override async Task OnInitializedAsync()
    {
        var currentTime = TimeProvider.GetLocalNow();
        SelectedDate = currentTime.Date;
        await base.OnInitializedAsync();
        _isSolarPredictionEnabled = await EnergyDataService.SolarPowerPredictionEnabled();
        await InvokeAsync(() => StateHasChanged());

        // Configure consumption chart options
        _chartOptions = GetChartOptions();

        await RefreshData(DateOnly.FromDateTime(SelectedDate.Value));
    }

    private ApexChartOptions<DtoChartValue<int, decimal?>> GetChartOptions()
    {
        var options = ApexChartHelper.GetDefaultChartOptions<DtoChartValue<int, decimal?>>(true);
        options.Chart.Stacked = false;
        options.Chart.Height = ChartHeightValue;
        options.Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Min = 0,
                Title = new AxisTitle { Text = T(TranslationKeys.Kwh) },
            },
            new YAxis
            {
                Opposite = true,
                Min = 0,
                Max = 100,
                Title = new AxisTitle { Text = T(TranslationKeys.Key) },
                DecimalsInFloat = 0,
                SeriesName = new SeriesName()
                {
                    T(TranslationKeys.HomeBatterySoc),
                },
            },
        };
        var markerSizes = new List<double>();
        var fillTypes = new List<FillType>();
        var opacities = new List<double>();
        var strokeWidths = new List<double>();

        var numberOfLineCharts = 8;
        if (_isSolarPredictionEnabled)
        {
            numberOfLineCharts++;
        }

        for (var i = 0; i < numberOfLineCharts; i++)
        {
            markerSizes.Add(4);
            fillTypes.Add(FillType.Solid);
            opacities.Add(0.2);
            strokeWidths.Add(3);
        }

        options.Markers = new Markers
        {
            Size = markerSizes,
            Hover = new()
            {
                SizeOffset = 5,
            },
        };
        options.Fill = new Fill
        {
            Type = fillTypes,
            Opacity = opacities,
        };
        options.Stroke = new Stroke
        {
            Width = strokeWidths, // Only line has stroke
            Curve = Curve.Smooth,
        };
        options.Tooltip = new Tooltip
        {
            Shared = true,
        };

        return options;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ChartWidthCalculator.ChartWidthChanged += OnChartWidthChangedAsync;
            await ChartWidthCalculator.InitAsync();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private class LegendItemData
    {
        public string TooltipText { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
        public decimal Value { get; set; }
        public string Icon { get; set; } = string.Empty;
    }

    private List<LegendItemData> GetLegendItems()
    {
        var items = new List<LegendItemData>();
        // Solar Values
        if (_isSolarPredictionEnabled && SolarPredictionData != null)
        {
            items.Add(new LegendItemData
            {
                TooltipText = GetRelevantSolarPredictionText(),
                Color = Constants.SolarPowerPredictionColor,
                Icon = Constants.SolarPowerIcon,
                Value = GetRelevantSolarPrediction(),
            });
        }
        if (SolarActualData != null)
        {
            items.Add(new LegendItemData
            {
                TooltipText = T(TranslationKeys.SolarActual),
                Color = Constants.SolarPowerColor,
                Icon = Constants.SolarPowerIcon,
                Value = SolarActualData.Sum(v => v.Value ?? 0),
            });
        }
        // House Values
        if (HousePredictionData != null)
        {
            items.Add(new LegendItemData
            {
                TooltipText = T(TranslationKeys.HousePrediction),
                Color = Constants.HomeConsumptionPredictionColor,
                Icon = Constants.HomePowerIcon,
                Value = HousePredictionData.Sum(v => v.Value ?? 0),
            });
        }
        if (HouseActualData != null)
        {
            items.Add(new LegendItemData
            {
                TooltipText = T(TranslationKeys.HouseActual),
                Color = Constants.HomeConsumptionChartColor,
                Icon = Constants.HomePowerIcon,
                Value = HouseActualData.Sum(v => v.Value ?? 0),
            });
        }
        // Battery Values
        if (BatteryChargingData != null)
        {
            var chargingValue = BatteryChargingData.Sum(v => v.Value ?? 0);
            if (chargingValue > 0)
            {
                items.Add(new LegendItemData
                {
                TooltipText = T(TranslationKeys.BatteryCharged),
                    Color = Constants.BatteryChargingColor,
                    Icon = Constants.HomeBatteryIcon,
                    Value = chargingValue,
                });
            }
        }
        if (BatteryDischargingData != null)
        {
            var dischargingValue = BatteryDischargingData.Sum(v => v.Value ?? 0);
            if (dischargingValue > 0)
            {
                items.Add(new LegendItemData
                {
                TooltipText = T(TranslationKeys.BatteryDischarged),
                    Color = Constants.BatteryDischargingColor,
                    Icon = Constants.HomeBatteryIcon,
                    Value = dischargingValue,
                });
            }
        }

        if (PowerToGridData != null)
        {
            var toGridValue = PowerToGridData.Sum(v => v.Value ?? 0);
            if (toGridValue > 0)
            {
                items.Add(new LegendItemData
                {
                TooltipText = T(TranslationKeys.ToGrid),
                    Color = Constants.GridExportColor,
                    Icon = Constants.GridPoleIcon,
                    Value = toGridValue,
                });
            }
        }

        if (PowerFromGridData != null)
        {
            var fromGridValue = PowerFromGridData.Sum(v => v.Value ?? 0);
            if (fromGridValue > 0)
            {
                items.Add(new LegendItemData
                {
                TooltipText = T(TranslationKeys.FromGrid),
                    Color = Constants.GridImportColor,
                    Icon = Constants.GridPoleIcon,
                    Value = fromGridValue,
                });
            }
        }
        return items;
    }

    private async Task RefreshData(DateOnly date)
    {
        // Cancel any ongoing refresh tasks.
        _refreshCancellationTokenSource.Cancel();
        _refreshCancellationTokenSource.Dispose();
        _refreshCancellationTokenSource = new CancellationTokenSource();
        CancellationToken token = _refreshCancellationTokenSource.Token;

        _dataLoaded = false;
        await Task.Delay(RedrawDelayMilliseconds);
        await InvokeAsync(StateHasChanged);

        HousePredictionData = default;
        SolarPredictionData = default;
        HouseActualData = default;
        SolarActualData = default;
        BatteryDischargingData = default;
        PowerFromGridData = default;
        PowerToGridData = default;
        BatteryChargingData = default;

        try
        {
            // Start all tasks
            var housePredictionTask = EnergyDataService.GetPredictedHouseConsumptionByLocalHour(date, token);
            var solarActualTask = EnergyDataService.GetActualSolarProductionByLocalHour(date, token);
            var houseActualTask = EnergyDataService.GetActualHouseConsumptionByLocalHour(date, token);
            var gridFromTask = EnergyDataService.GetActualPowerFromGridByLocalHour(date, token);
            var gridToTask = EnergyDataService.GetActualPowerToGridByLocalHour(date, token);
            var batteryChargingTask = EnergyDataService.GetActualHomeBatteryChargingPowerByLocalHour(date, token);
            var batteryDischargingTask = EnergyDataService.GetActualHomeBatteryDischargingPowerByLocalHour(date, token);
            var batterySocTask = EnergyDataService.GetActualHomeBatterySocByLocalHour(date, token);

            if (_isSolarPredictionEnabled)
            {
                var solarPredictionTask = EnergyDataService.GetPredictedSolarProductionByLocalHour(date, token);
                var solarPredictionData = await solarPredictionTask;
                token.ThrowIfCancellationRequested();
                SolarPredictionData = solarPredictionData
                    .Select(e => new DtoChartValue<int, decimal?>(e.Key, new(e.Value / 1000.0)))
                    .ToList();
            }

            // Wait for all tasks
            var housePredictionData = await housePredictionTask;
            token.ThrowIfCancellationRequested();
            var solarActualData = await solarActualTask;
            token.ThrowIfCancellationRequested();
            var houseActualData = await houseActualTask;
            token.ThrowIfCancellationRequested();
            var gridFromData = await gridFromTask;
            token.ThrowIfCancellationRequested();
            var gridToData = await gridToTask;
            token.ThrowIfCancellationRequested();
            var batteryChargingDataRaw = await batteryChargingTask;
            token.ThrowIfCancellationRequested();
            var batteryDischargingDataRaw = await batteryDischargingTask;
            token.ThrowIfCancellationRequested();
            var batterySocData = await batterySocTask;
            token.ThrowIfCancellationRequested();

            // Convert prediction data
            HousePredictionData = housePredictionData
                .Select(e => new DtoChartValue<int, decimal?>(e.Key, new(e.Value / 1000.0)))
                .ToList();

            // Calculate stacked area data
            var hours = Enumerable.Range(0, 24).ToList();

            BatteryDischargingData = new();
            PowerFromGridData = new();
            PowerToGridData = new();
            BatteryChargingData = new();
            BatterySoc = new();
            SolarActualData = new();
            HouseActualData = new();

            foreach (var hour in hours)
            {
                var gridFrom = gridFromData.ContainsKey(hour) ? gridFromData[hour] / 1000.0 : (double?)null;
                var gridTo = gridToData.ContainsKey(hour) ? gridToData[hour] / 1000.0 : (double?)null;
                var batteryCharging = batteryChargingDataRaw.ContainsKey(hour) ? batteryChargingDataRaw[hour] / 1000.0 : (double?)null;
                var batteryDischarging = batteryDischargingDataRaw.ContainsKey(hour) ? batteryDischargingDataRaw[hour] / 1000.0 : (double?)null;
                var solarActual = solarActualData.ContainsKey(hour) ? solarActualData[hour] / 1000.0 : (double?)null;
                var houseActual = houseActualData.ContainsKey(hour) ? houseActualData[hour] / 1000.0 : (double?)null;

                var dateTime = DateTime.SpecifyKind(new DateTime(date.Year, date.Month, date.Day, hour, 0, 0), DateTimeKind.Local);
                var currentDate = DateTimeProvider.Now();
                var batterySoc = (batterySocData.ContainsKey(hour) && (currentDate > dateTime)) ? batterySocData[hour] : (decimal?)null;


                SolarActualData.Add(new(hour, (decimal?)solarActual));
                HouseActualData.Add(new(hour, (decimal?)houseActual));
                BatteryDischargingData.Add(new(hour, (decimal?)batteryDischarging));
                PowerFromGridData.Add(new(hour, (decimal?)gridFrom));
                BatterySoc.Add(new(hour, batterySoc));

                // For production chart - show where solar production goes (as positive values)
                PowerToGridData.Add(new(hour, (decimal?)gridTo));
                BatteryChargingData.Add(new(hour, (decimal?)batteryCharging));
            }

            _dataLoaded = true;

            if (_consumptionChart != null)
            {
                await _consumptionChart.UpdateSeriesAsync();
            }

            StateHasChanged();
        }
        catch (OperationCanceledException)
        {
            // The refresh was canceled. Optionally log or handle the cancellation.
        }
    }

    private decimal GetRelevantSolarPrediction()
    {
        if (SolarPredictionData == null) return 0;

        // If it's today and we're partway through the day, show prediction from now
        if (SelectedDate == TimeProvider.GetLocalNow().Date)
        {
            return SolarPredictionData.Where(v => v.Key > TimeProvider.GetLocalNow().Hour).Sum(v => v.Value ?? 0);
        }

        // Otherwise show total prediction
        return SolarPredictionData.Sum(v => v.Value ?? 0);
    }

    private string GetRelevantSolarPredictionText() =>
        SelectedDate == TimeProvider.GetLocalNow().Date
            ? T(TranslationKeys.SolarPredictionFromNow)
            : T(TranslationKeys.SolarPrediction);

    private void PreviousDay()
    {
        if (SelectedDate == default)
        {
            return;
        }
        SelectedDate = SelectedDate.Value.AddDays(-1);
    }

    private void NextDay()
    {
        if (SelectedDate == default)
        {
            return;
        }
        if (SelectedDate < MaxAllowedDate)
        {
            SelectedDate = SelectedDate.Value.AddDays(1);
        }
    }

    private bool IsPreviousDisabled => false; // No limit for going back
    private bool IsNextDisabled => SelectedDate >= MaxAllowedDate;

    private async Task SelectedDateChanged(DateTime? newDate)
    {
        if (newDate == default)
        {
            return;
        }

        if (newDate > MaxAllowedDate)
        {
            var currentDate = TimeProvider.GetLocalNow().Date;
            var allowedDays = (MaxAllowedDate - currentDate).Days;
            Snackbar.Add(Format("Cannot select a date more than {0} day(s) in the future", allowedDays), Severity.Error);
            return;
        }
        SelectedDate = newDate;
        await RefreshData(DateOnly.FromDateTime(newDate.Value));
    }

    private async Task ExpandedChanged(bool isExpanded)
    {
        _isExpanded = isExpanded;
        if (!isExpanded)
        {
            // When collapsed, reset to current day
            var currentDate = TimeProvider.GetLocalNow().Date;
            if (SelectedDate != currentDate)
            {
                SelectedDate = currentDate;
                await RefreshData(DateOnly.FromDateTime(currentDate));
            }
            return;
        }

        if (_consumptionChart != default)
        {
            await _consumptionChart.UpdateOptionsAsync(false, false, false);
        }
    }

    private async ValueTask OnChartWidthChangedAsync()
    {
        await InvokeAsync(StateHasChanged);

        await Task.Delay(RedrawDelayMilliseconds);

        if (_consumptionChart != default)
        {
            await _consumptionChart.UpdateOptionsAsync(false, false, false);
        }
    }

    public void Dispose()
    {
        ChartWidthCalculator.ChartWidthChanged -= OnChartWidthChangedAsync;
        _consumptionChart?.Dispose();
    }

    private string T(string key) =>
        TextLocalizer.Get<EnergyPredictionComponentLocalizationRegistry>(key, typeof(SharedComponentLocalizationRegistry))
        ?? key;

    private string Format(string key, params object?[] arguments) =>
        string.Format(CultureInfo.CurrentCulture, T(key), arguments);
}
