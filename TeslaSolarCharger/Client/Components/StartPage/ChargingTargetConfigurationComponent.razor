@using MudBlazor
@using System.Globalization
@using System.Linq
@using TeslaSolarCharger.Client.Helper.Contracts
@using TeslaSolarCharger.Client.Dialogs
@using TeslaSolarCharger.Client.Services.Contracts
@using TeslaSolarCharger.Client.Wrapper
@using TeslaSolarCharger.Shared.Dtos.Home

@inject IHomeService HomeService
@inject ISnackbar Snackbar
@inject IJavaScriptWrapper JavaScriptWrapper
@inject IDialogService DialogService
@inject IBaseConfigurationService BaseConfigurationService

<div class="d-flex flex-wrap gap-2">
    <h3>Charging Targets</h3>
    <RightAlignedButtonComponent StartIcon="@Icons.Material.Filled.Add"
                                 ButtonText="Add Target"
                                 OnButtonClicked="AddTarget"></RightAlignedButtonComponent>
</div>

@if (_targets == null)
{
    <PlaceholderComponent Count="3" />
}
else if (!_targets.Any())
{
    <div class="text-muted">Nothing planned</div>
}
else
{
    @foreach (var chargingTarget in _targets)
    {
        <div class="card mb-3"
             style="cursor: pointer;"
             @onclick="() => OpenEditDialog(chargingTarget)">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                    <div class="flex-grow-1">
                        <div class="fw-semibold">@GetTargetTitle(chargingTarget)</div>
                        <div class="text-muted">@GetTargetTimeDescription(chargingTarget)</div>
                        <div class="text-muted">@GetScheduleDescription(chargingTarget)</div>
                        @if (_homeBatteryValuesAvailable)
                        {
                            <div class="text-muted">@GetHomeBatteryText(chargingTarget)</div>
                        }
                    </div>
                    <div @onclick:stopPropagation="true">
                        <MudIconButton Color="Color.Error"
                                   Variant="Variant.Outlined"
                                   Icon="@Icons.Material.Filled.Delete"
                                   OnClick="() => DeleteItem(chargingTarget)">
                        </MudIconButton>
                    </div>
                    
                </div>
                @if (!string.Equals(chargingTarget.ClientTimeZone, _timeZone, StringComparison.OrdinalIgnoreCase))
                {
                    <MudAlert Severity="Severity.Warning"
                              Dense="true"
                              NoIcon="true"
                              Class="mt-2"
                              ContentAlignment="HorizontalAlignment.Left">
                        <div class="fw-semibold">Saved in different timezone</div>
                        <div class="small">This element was saved in a different timezone than your device currently is in. The timezone is set when adding a new target, so to fix this issue, you need to delete this target and readd it.</div>
                    </MudAlert>
                }
            </div>
        </div>
    }
}

@code {
        [Parameter]
        public int CarId { get; set; }

    private List<DtoCarChargingTarget>? _targets;

    private string? _timeZone;

    private bool _homeBatteryValuesAvailable;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _timeZone = await JavaScriptWrapper.GetTimeZoneId();
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        await RefreshChargingTargets();
        _homeBatteryValuesAvailable = await BaseConfigurationService.HomeBatteryValuesAvailable();
    }

    private async Task RefreshChargingTargets()
    {
        var result = await HomeService.GetCarChargingTargets(CarId);
        if (result == default)
        {
            _targets = default;
            return;
        }
        _targets = result.ToList();
    }

    private async Task AddTarget()
    {
        await OpenEditDialog();
    }

    private async Task DeleteItem(DtoCarChargingTarget chargingTarget)
    {
        if (chargingTarget.Id != default)
        {
            var result = await HomeService.DeleteCarChargingTarget(chargingTarget.Id);
            if (result.HasError)
            {
                Snackbar.Add($"Could not delete: {result.ErrorMessage}", Severity.Error);
                return;
            }
        }
        _targets?.Remove(chargingTarget);
        Snackbar.Add("Deleted.", Severity.Success);
    }

    private async Task OpenEditDialog(DtoCarChargingTarget? chargingTarget = default)
    {
        var editableTarget = new EditableItem<DtoCarChargingTarget>(CloneTarget(chargingTarget));
        editableTarget.Item.ClientTimeZone ??= _timeZone;

        var parameters = new DialogParameters<ChargingTargetConfigurationDialog>
        {
            { x => x.CarId, CarId },
            { x => x.Target, editableTarget },
            { x => x.HomeBatteryValuesAvailable, _homeBatteryValuesAvailable },
            { x => x.CurrentTimeZone, _timeZone },
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            FullWidth = true,
            MaxWidth = MaxWidth.Medium,
        };

        var dialog = await DialogService.ShowAsync<ChargingTargetConfigurationDialog>("Charging target", parameters, options);
        var result = await dialog.Result;
        if (result?.Canceled == false)
        {
            await RefreshChargingTargets();
        }
    }

    private static DtoCarChargingTarget CloneTarget(DtoCarChargingTarget? target)
    {
        if (target is null)
        {
            return new DtoCarChargingTarget();
        }

        return new DtoCarChargingTarget
        {
            Id = target.Id,
            TargetSoc = target.TargetSoc,
            DischargeHomeBatteryToMinSoc = target.DischargeHomeBatteryToMinSoc,
            TargetDate = target.TargetDate,
            TargetTime = target.TargetTime,
            RepeatOnMondays = target.RepeatOnMondays,
            RepeatOnTuesdays = target.RepeatOnTuesdays,
            RepeatOnWednesdays = target.RepeatOnWednesdays,
            RepeatOnThursdays = target.RepeatOnThursdays,
            RepeatOnFridays = target.RepeatOnFridays,
            RepeatOnSaturdays = target.RepeatOnSaturdays,
            RepeatOnSundays = target.RepeatOnSundays,
            ClientTimeZone = target.ClientTimeZone,
        };
    }

    private static string GetTargetTitle(DtoCarChargingTarget target)
    {
        return target.TargetSoc.HasValue
            ? $"Target SoC: {target.TargetSoc.Value}%"
            : "Discharge home battery";
    }

    private static string GetTargetTimeDescription(DtoCarChargingTarget target)
    {
        return target.TargetTime.HasValue
            ? $"Target time: {target.TargetTime.Value:hh\\:mm}"
            : "No target time configured";
    }

    private static string GetScheduleDescription(DtoCarChargingTarget target)
    {
        var repeatDays = GetRepeatDays(target).ToList();
        if (repeatDays.Any())
        {
            return $"Repeats on {string.Join(", ", repeatDays)}";
        }

        if (target.TargetDate.HasValue)
        {
            return $"Runs on {target.TargetDate.Value.ToString("d", CultureInfo.CurrentCulture)}";
        }

        return "No date configured";
    }

    private static IEnumerable<string> GetRepeatDays(DtoCarChargingTarget target)
    {
        if (target.RepeatOnMondays)
        {
            yield return "Mon";
        }
        if (target.RepeatOnTuesdays)
        {
            yield return "Tue";
        }
        if (target.RepeatOnWednesdays)
        {
            yield return "Wed";
        }
        if (target.RepeatOnThursdays)
        {
            yield return "Thu";
        }
        if (target.RepeatOnFridays)
        {
            yield return "Fri";
        }
        if (target.RepeatOnSaturdays)
        {
            yield return "Sat";
        }
        if (target.RepeatOnSundays)
        {
            yield return "Sun";
        }
    }

    private string GetHomeBatteryText(DtoCarChargingTarget chargingTarget)
    {
        if (!_homeBatteryValuesAvailable)
        {
            return string.Empty;
        }
        var stringToReturn = "Home battery: ";
        if (chargingTarget.TargetSoc == default)
        {
            if (chargingTarget.DischargeHomeBatteryToMinSoc)
            {
                stringToReturn += "Discharge to min SoC";
            }
        }
        else
        {
            if (chargingTarget.DischargeHomeBatteryToMinSoc)
            {
                stringToReturn += "Try to not use grid energy by reducing car's charging speed";
            }
            else
            {
                stringToReturn += "Don't reduce cars's charging speed, grid energy may be used even if home battery has enough energy";
            }
        }
        return stringToReturn;
    }

}
