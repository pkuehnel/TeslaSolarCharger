@using TeslaSolarCharger.Client.Services.Contracts
@using TeslaSolarCharger.Shared.Localization
@using TeslaSolarCharger.Shared.Localization.Contracts
@using TeslaSolarCharger.Shared.Localization.Registries
@using TeslaSolarCharger.Shared.Localization.Registries.Components.StartPage

@inject IHomeService HomeService
@inject ILogger<CarSelectorComponent> Logger
@inject ITextLocalizationService TextLocalizer

@if (_carOptions == default)
{
    <PlaceholderComponent Count="1"></PlaceholderComponent>
}
else
{
    <GenericInput T="int?"
                  @key="_genericInputKey"
                  For="() => LocalSelectedCarId"
                  LabelName='@T(TranslationKeys.CarSelectorConnectedCarLabel)'
                  DropDownOptions="_carOptions"
                  OnValueChanged="OnLocalCarChanged"></GenericInput>
}

@code {
    [Parameter]
    public int? SelectedCarId { get; set; }

    [Parameter]
    public EventCallback<int?> OnCarSelected { get; set; }

    private Guid _genericInputKey = Guid.NewGuid();

    private int? LocalSelectedCarId { get; set; }

    private Dictionary<int, string>? _carOptions;


    protected override void OnParametersSet()
    {
        Logger.LogDebug("OnParametersSet called with SelectedCarId: {SelectedCarId}", SelectedCarId);
        base.OnParametersSet();
        if (LocalSelectedCarId != (SelectedCarId ?? 0))
        {
            Logger.LogDebug("Updating LocalSelectedCarId from parameter: {SelectedCarId}", SelectedCarId);
            LocalSelectedCarId = SelectedCarId ?? 0;
            _genericInputKey = Guid.NewGuid();
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var options = await HomeService.GetLoadPointCarOptions();
        _carOptions = options;
    }

    private async Task OnLocalCarChanged(int? newCarId)
    {
        Logger.LogTrace("{method}({newCarId})", nameof(OnLocalCarChanged), newCarId);
        LocalSelectedCarId = newCarId ?? 0;
        var carIdToInvoke = newCarId == 0 ? null : newCarId;
        await OnCarSelected.InvokeAsync(carIdToInvoke);
    }

    private string T(string key) =>
        TextLocalizer.Get<CarSelectorComponentLocalizationRegistry>(key, typeof(SharedComponentLocalizationRegistry))
        ?? key;
}
