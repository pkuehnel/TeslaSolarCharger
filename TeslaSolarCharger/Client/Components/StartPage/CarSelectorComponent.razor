@using TeslaSolarCharger.Client.Services.Contracts
@inject IHomeService HomeService
@inject ILogger<CarSelectorComponent> Logger

@if (_carOptions == default)
{
    <PlaceholderComponent Count="1"></PlaceholderComponent>
}
else
{
    <GenericInput T="int?"
                  @key="_genericInputKey"
                  For="() => LocalSelectedCarId"
                  DropDownOptions="_carOptions"
                  OnValueChanged="OnLocalCarChanged"
                  PostfixButtonStartIcon="@(LocalSelectedCarId == default ? null : Icons.Material.Filled.CallSplit)"
                  OnButtonClicked="_ => OnLocalCarChanged(null)"></GenericInput>
}

@code {
    [Parameter]
    public int? SelectedCarId { get; set; }

    [Parameter]
    public EventCallback<int?> OnCarSelected { get; set; }

    private Guid _genericInputKey = Guid.NewGuid();

    private int? LocalSelectedCarId { get; set; }

    private Dictionary<int, string>? _carOptions;

    private bool _isUpdatingFromParameter;

    protected override void OnParametersSet()
    {
        Logger.LogDebug("OnParametersSet called with SelectedCarId: {SelectedCarId}", SelectedCarId);
        base.OnParametersSet();
        if (LocalSelectedCarId != SelectedCarId)
        {
            Logger.LogDebug("Updating LocalSelectedCarId from parameter: {SelectedCarId}", SelectedCarId);
            _isUpdatingFromParameter = true;
            LocalSelectedCarId = SelectedCarId;
            _genericInputKey = Guid.NewGuid();
            StateHasChanged();
        }
        else
        {
            Logger.LogDebug("No update needed for LocalSelectedCarId, it remains: {LocalSelectedCarId}", LocalSelectedCarId);
            _isUpdatingFromParameter = false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var options = await HomeService.GetLoadPointCarOptions();
        _carOptions = options;
    }

    private async Task OnLocalCarChanged(int? newCarId)
    {
        Logger.LogTrace("{method}({newCarId}", nameof(OnLocalCarChanged), newCarId);
        if (_isUpdatingFromParameter)
        {
            Logger.LogDebug("Ignoring OnLocalCarChanged call because we are updating from parameter: {newCarId}", newCarId);
            _isUpdatingFromParameter = false;
            return;
        }
        LocalSelectedCarId = newCarId;
        await OnCarSelected.InvokeAsync(newCarId);
    }
}
